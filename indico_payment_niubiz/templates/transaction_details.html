{% extends 'events/payment/transaction_details.html' %}

{% block details %}
    {% set txn = transaction if transaction is defined else none %}
    {% set base_payload = authorization if authorization is defined else (txn.data if txn else {}) %}
    {% set raw_payload = raw_authorization if raw_authorization is defined and raw_authorization else base_payload %}
    {% if base_payload is mapping and base_payload.get('data') is mapping %}
        {% set payload = base_payload['data'] %}
    {% else %}
        {% set payload = base_payload %}
    {% endif %}
    {% set amount_value = amount if amount is defined else (txn.amount if txn else 0) %}
    {% set currency_value = currency if currency is defined else (txn.currency if txn else 'PEN') %}
    {% set purchase_number_value = purchase_number or raw_payload.get('purchaseNumber') or payload.get('purchaseNumber') or (raw_payload.get('order') or {}).get('purchaseNumber') %}
    {% set action_code_value = action_code or payload.get('ACTION_CODE') or payload.get('actionCode') %}
    {% set success_value = success if success is defined else (action_code_value == '000') %}
    {% if status_token is defined and status_token %}
        {% set status_token_value = status_token %}
    {% else %}
        {% set status_token_value = status_label if status_label is defined else (payload.get('STATUS') or payload.get('status')) %}
    {% endif %}
    {% if status_label is defined %}
        {% set status_text = status_label %}
    {% elif status_token_value and status_token_value.lower() in ('cancelled', 'canceled') %}
        {% set status_text = _('Cancelled') %}
    {% else %}
        {% set status_text = success_value and _('Successful') or _('Declined') %}
    {% endif %}
    {% set transaction_id_value = transaction_id or payload.get('TRANSACTION_ID') or payload.get('transactionId') or payload.get('operationNumber') or raw_payload.get('transactionId') %}
    {% set authorization_code_value = authorization_code or payload.get('AUTHORIZATION_CODE') or payload.get('authorizationCode') %}
    {% set card_payload = masked_card or payload.get('CARD') or payload.get('card') or payload.get('cardNumber') %}
    {% if card_payload is mapping %}
        {% set masked_card_value = card_payload.get('PAN') or card_payload.get('pan') or card_payload.get('maskedCard') %}
    {% else %}
        {% set masked_card_value = card_payload %}
    {% endif %}
    {% set transaction_date_value = transaction_date or payload.get('TRANSACTION_DATE') or payload.get('transactionDate') %}
    <dt>{% trans %}Número de pedido{% endtrans %}</dt>
    <dd>{{ purchase_number_value or '-' }}</dd>
    <dt>{% trans %}ID de transacción{% endtrans %}</dt>
    <dd>{{ transaction_id_value or '-' }}</dd>
    <dt>{% trans %}Código de autorización{% endtrans %}</dt>
    <dd>{{ authorization_code_value or '-' }}</dd>
    <dt>{% trans %}Tarjeta enmascarada{% endtrans %}</dt>
    <dd>{{ masked_card_value or '-' }}</dd>
    <dt>{% trans %}Fecha y hora{% endtrans %}</dt>
    <dd>{{ transaction_date_value or '-' }}</dd>
    <dt>{% trans %}Monto y moneda{% endtrans %}</dt>
    <dd>
        {{ format_currency(amount_value, currency_value, locale=session.lang) }}
        <span class="text-muted">({{ currency_value }})</span>
    </dd>
    {% set base_status_text = _('Rechazado') %}
    {% if status_label is defined and status_label %}
        {% set status_text = status_label %}
    {% elif status_token_value %}
        {% set status_lower = status_token_value.lower() %}
        {% if status_lower in ('cancelled', 'canceled') %}
            {% set status_text = _('Cancelado') %}
        {% elif status_lower in ('expired', 'expirada') %}
            {% set status_text = _('Expirado') %}
        {% elif status_lower in ('completed', 'complete', 'success', 'successful', 'authorized', 'authorised', 'autorizado', 'autorizada', 'approved') %}
            {% set status_text = _('Autorizado') %}
        {% elif status_lower in ('rejected', 'rechazado', 'denied') %}
            {% set status_text = _('Rechazado') %}
        {% else %}
            {% set status_text = base_status_text %}
        {% endif %}
    {% elif success_value %}
        {% set status_text = _('Autorizado') %}
    {% else %}
        {% set status_text = base_status_text %}
    {% endif %}
    <dt>{% trans %}Estado final{% endtrans %}</dt>
    <dd>
        {{ status_text }}
        {% if action_code_value %}
            <span class="text-muted">({% trans code=action_code_value %}código {{ code }}{% endtrans %})</span>
        {% endif %}
    </dd>
{% endblock %}

{% block warning_box %}{% endblock %}

{% block content %}
    {% if standalone %}
        <div class="i-box">
            <div class="i-box-header">
                <h3 class="i-box-title">{% trans %}Niubiz transaction{% endtrans %}</h3>
            </div>
            <div class="i-box-content">
                <dl class="i-data-list">
                    {{ self.details() }}
                </dl>
            </div>
        </div>
    {% else %}
        {{ super() }}
    {% endif %}
{% endblock %}
