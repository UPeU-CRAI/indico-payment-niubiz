{% set has_session = sessionKey %}

<div class="i-box">
  <div class="i-box-content">
    {% if not has_session %}
      <p>
        {% trans %}Click the button below to start the Niubiz checkout process.{% endtrans %}
      </p>
      <form action="{{ url_for('payment_niubiz.start', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id) }}"
            method="post">
        <button type="submit" class="btn btn-primary">
          {% trans %}Pay with Niubiz{% endtrans %}
        </button>
      </form>
    {% else %}
      <p>
        {% trans amount=format_currency(amount, currency or 'PEN', locale=session.lang) %}Estás a punto de pagar {{ amount }} con Niubiz.{% endtrans %}
      </p>
      {% if session_expiration %}
        <p class="text-muted small">
          {% trans expiration=session_expiration %}La sesión de pago expira el {{ expiration }}.{% endtrans %}
        </p>
      {% endif %}
      <div class="d-flex flex-column flex-sm-row gap-2">
        <button type="button" class="btn btn-primary" onclick="launchNiubizCheckout()">
          {% trans %}Pay with Niubiz{% endtrans %}
        </button>
        <a class="btn btn-secondary" href="{{ cancel_url or url_for('payment_niubiz.cancel', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id) }}">
          {% trans %}Cancel payment{% endtrans %}
        </a>
      </div>
      <div id="niubiz-error" class="alert alert-danger d-none mt-3" role="alert"></div>

      <script src="{{ checkout_js_url or 'https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js' }}"></script>
      {% set checkout_amount = amount_value if amount_value is defined else amount %}
      <script>
        (function() {
          const checkoutConfig = {
            sessionkey: {{ sessionKey|tojson }},
            channel: "web",
            merchantid: {{ merchant_id|tojson }},
            purchasenumber: {{ purchase_number|tojson }},
            amount: {{ ('%.2f' % checkout_amount)|tojson }},
            callbackurl: {{ url_for('payment_niubiz.success', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id, _external=True)|tojson }}
          };
          {% if merchant_logo_url %}
          checkoutConfig.merchantlogo = {{ merchant_logo_url|tojson }};
          {% endif %}
          {% if checkout_button_color %}
          checkoutConfig.formbuttoncolor = {{ checkout_button_color|tojson }};
          {% endif %}
          const errorBox = document.getElementById('niubiz-error');
          const fieldErrorClass = 'niubiz-field-error';

          function showCheckoutError(message) {
            if (!errorBox) {
              return;
            }
            errorBox.textContent = message;
            errorBox.classList.remove('d-none');
          }

          function clearCheckoutError() {
            if (!errorBox) {
              return;
            }
            errorBox.textContent = '';
            errorBox.classList.add('d-none');
          }

          function setFieldError(fieldName, message) {
            if (!fieldName) {
              showCheckoutError(message);
              return;
            }
            const field = document.querySelector('[data-niubiz-field="' + fieldName + '"]');
            if (!field) {
              showCheckoutError(message);
              return;
            }
            const container = field.closest('.form-group, .i-form-group, .mb-3') || field.parentElement;
            if (!container) {
              showCheckoutError(message);
              return;
            }
            let feedback = container.querySelector('.' + fieldErrorClass);
            if (!feedback) {
              feedback = document.createElement('div');
              feedback.className = fieldErrorClass + ' invalid-feedback d-block';
              container.appendChild(feedback);
            }
            feedback.textContent = message || '';
            feedback.classList.toggle('d-none', !message);
          }

          function clearFieldError(fieldName) {
            if (!fieldName) {
              return;
            }
            const field = document.querySelector('[data-niubiz-field="' + fieldName + '"]');
            if (!field) {
              return;
            }
            const container = field.closest('.form-group, .i-form-group, .mb-3') || field.parentElement;
            if (!container) {
              return;
            }
            const feedback = container.querySelector('.' + fieldErrorClass);
            if (feedback) {
              feedback.textContent = '';
              feedback.classList.add('d-none');
            }
          }

          function buildErrorMessage(error, fallback) {
            if (error) {
              if (typeof error === 'string') {
                return error;
              }
              return error.userMessage || error.errorMessage || error.message || fallback;
            }
            return fallback;
          }

          function handleCheckoutError(error) {
            const fallback = {{ _('No fue posible iniciar el checkout de Niubiz. Vuelve a intentarlo.')|tojson }};
            const message = buildErrorMessage(error, fallback);
            showCheckoutError(message);
          }

          function handleCheckoutResponse(response) {
            if (!response || typeof response !== 'object') {
              return;
            }
            const data = response.data || response;
            if (data.error || response.error || data.success === false) {
              const errorMessage = data.error && (data.error.userMessage || data.error.errorMessage || data.error.message);
              const message = errorMessage || buildErrorMessage(response.error, {{ _('El checkout de Niubiz reportó un error inesperado. Vuelve a intentarlo.')|tojson }});
              showCheckoutError(message);
              return;
            }
            const code = data.ACTION_CODE || data.actionCode;
            if (code && code !== '000') {
              const description = data.ACTION_DESCRIPTION || data.ACTION_MESSAGE || data.actionDescription || data.actionMessage;
              let message = {{ _('Niubiz rechazó el pago. Vuelve a intentarlo o contacta al soporte si el problema persiste.')|tojson }};
              message += ' (código ' + code + ')';
              if (description) {
                message += ' - ' + description;
              }
              showCheckoutError(message);
            }
          }

          function normaliseChangePayload(event) {
            if (!event) {
              return {};
            }
            if (event.detail && typeof event.detail === 'object') {
              return event.detail;
            }
            return event;
          }

          function handlePayformChange(event) {
            const detail = normaliseChangePayload(event);
            const fieldName = detail && (detail.field || detail.name || detail.code);
            if (detail && detail.isValid === false) {
              const message = detail.message || detail.userMessage || detail.errorMessage ||
                {{ _('Revisa los datos ingresados en el formulario de pago.')|tojson }};
              setFieldError(fieldName, message);
              showCheckoutError(message);
            } else if (fieldName) {
              clearFieldError(fieldName);
              if (!errorBox || errorBox.classList.contains('d-none')) {
                return;
              }
            }
          }

          function initDetachedPayformListeners() {
            const payform = (window.Niubiz && window.Niubiz.payform) || window.NiubizPayform || window.payform;
            if (!payform) {
              return;
            }
            if (typeof payform.on === 'function') {
              try {
                payform.on('change', handlePayformChange);
              } catch (error) {
                // ignore listener errors silently but keep logging in console
                console.warn('Niubiz payform change listener could not be registered', error);
              }
            }
            if (typeof payform.createToken === 'function' && !payform.__indicoNiubizWrapped) {
              const originalCreateToken = payform.createToken.bind(payform);
              payform.createToken = function() {
                return originalCreateToken.apply(this, arguments).catch(function(error) {
                  handleCheckoutError(error);
                  throw error;
                });
              };
              Object.defineProperty(payform, '__indicoNiubizWrapped', {
                value: true,
                enumerable: false,
                configurable: true,
                writable: true
              });
            }
          }

          function launchNiubizCheckout() {
            clearCheckoutError();
            if (typeof VisanetCheckout === 'undefined' || typeof VisanetCheckout.configure !== 'function') {
              showCheckoutError({{ _('La librería de checkout de Niubiz no está disponible en este momento.')|tojson }});
              return;
            }

            const config = Object.assign({}, checkoutConfig, {
              completeCallback: handleCheckoutResponse,
              errorCallback: handleCheckoutError
            });

            try {
              VisanetCheckout.configure(config);
              const opened = VisanetCheckout.open();
              if (opened === false) {
                showCheckoutError({{ _('No se pudo abrir el checkout de Niubiz. Vuelve a intentarlo.')|tojson }});
              }
            } catch (error) {
              handleCheckoutError(error);
            }
          }

          window.launchNiubizCheckout = launchNiubizCheckout;
          initDetachedPayformListeners();
          if ({% if has_session %}true{% else %}false{% endif %}) {
            document.addEventListener('DOMContentLoaded', function() {
              launchNiubizCheckout();
            });
          }
        })();
      </script>
    {% endif %}
  </div>
</div>
