{% set has_session = sessionKey %}

<div class="i-box">
  <div class="i-box-content">
    {% if not has_session %}
      <p>
        {% trans %}Click the button below to start the Niubiz checkout process.{% endtrans %}
      </p>
      <form action="{{ url_for('payment_niubiz.start', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id) }}"
            method="post">
        <button type="submit" class="btn btn-primary">
          {% trans %}Pay with Niubiz{% endtrans %}
        </button>
      </form>
    {% else %}
      <p>
        {% trans amount=format_currency(amount, currency or 'PEN', locale=session.lang) %}Estás a punto de pagar {{ amount }} con Niubiz.{% endtrans %}
      </p>
      <div class="d-flex flex-column flex-sm-row gap-2">
        <button type="button" class="btn btn-primary" onclick="launchNiubizCheckout()">
          {% trans %}Pay with Niubiz{% endtrans %}
        </button>
        <a class="btn btn-secondary" href="{{ cancel_url or url_for('payment_niubiz.cancel', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id) }}">
          {% trans %}Cancel payment{% endtrans %}
        </a>
      </div>
      <div id="niubiz-error" class="alert alert-danger d-none mt-3" role="alert"></div>

      <script src="{{ checkout_js_url or 'https://static-content-qas.vnforapps.com/v2/js/checkout.js' }}"></script>
      {% set checkout_amount = amount_value if amount_value is defined else amount %}
      <script>
        (function() {
          const checkoutConfig = {
            sessionkey: "{{ sessionKey }}",
            channel: "web",
            merchantid: "{{ merchant_id }}",
            purchasenumber: "{{ purchase_number }}",
            amount: "{{ '%.2f' % checkout_amount }}",
            callbackurl: "{{ url_for('payment_niubiz.success', event_id=event.id, reg_form_id=registration.registration_form.id, reg_id=registration.id, _external=True) }}"
          };
          const errorBox = document.getElementById('niubiz-error');

          function showCheckoutError(message) {
            if (!errorBox) {
              return;
            }
            errorBox.textContent = message;
            errorBox.classList.remove('d-none');
          }

          function clearCheckoutError() {
            if (!errorBox) {
              return;
            }
            errorBox.textContent = '';
            errorBox.classList.add('d-none');
          }

          function buildErrorMessage(error, fallback) {
            if (error) {
              if (typeof error === 'string') {
                return error;
              }
              return error.userMessage || error.errorMessage || error.message || fallback;
            }
            return fallback;
          }

          function handleCheckoutError(error) {
            const fallback = {{ _('No fue posible iniciar el checkout de Niubiz. Vuelve a intentarlo.')|tojson }};
            const message = buildErrorMessage(error, fallback);
            showCheckoutError(message);
          }

          function handleCheckoutResponse(response) {
            if (!response || typeof response !== 'object') {
              return;
            }
            const data = response.data || response;
            if (data.error || response.error || data.success === false) {
              const errorMessage = data.error && (data.error.userMessage || data.error.errorMessage || data.error.message);
              const message = errorMessage || buildErrorMessage(response.error, {{ _('El checkout de Niubiz reportó un error inesperado. Vuelve a intentarlo.')|tojson }});
              showCheckoutError(message);
              return;
            }
            const code = data.ACTION_CODE || data.actionCode;
            if (code && code !== '000') {
              const description = data.ACTION_DESCRIPTION || data.ACTION_MESSAGE || data.actionDescription || data.actionMessage;
              let message = {{ _('Niubiz rechazó el pago. Vuelve a intentarlo o contacta al soporte si el problema persiste.')|tojson }};
              message += ' (código ' + code + ')';
              if (description) {
                message += ' - ' + description;
              }
              showCheckoutError(message);
            }
          }

          function launchNiubizCheckout() {
            clearCheckoutError();
            if (typeof VisanetCheckout === 'undefined' || typeof VisanetCheckout.configure !== 'function') {
              showCheckoutError({{ _('La librería de checkout de Niubiz no está disponible en este momento.')|tojson }});
              return;
            }

            const config = Object.assign({}, checkoutConfig, {
              completeCallback: handleCheckoutResponse,
              errorCallback: handleCheckoutError
            });

            try {
              VisanetCheckout.configure(config);
              const opened = VisanetCheckout.open();
              if (opened === false) {
                showCheckoutError({{ _('No se pudo abrir el checkout de Niubiz. Vuelve a intentarlo.')|tojson }});
              }
            } catch (error) {
              handleCheckoutError(error);
            }
          }

          window.launchNiubizCheckout = launchNiubizCheckout;
          if ({% if has_session %}true{% else %}false{% endif %}) {
            document.addEventListener('DOMContentLoaded', function() {
              launchNiubizCheckout();
            });
          }
        })();
      </script>
    {% endif %}
  </div>
</div>
